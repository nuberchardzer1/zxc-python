name: Code Quality

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read

concurrency:
  cancel-in-progress: true
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}

jobs:
  cppcheck:
    name: Code Quality - Cppcheck
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Install Cppcheck and Cross-Compiler
        run: |
          sudo apt-get update
          sudo apt-get install -y cppcheck gcc-aarch64-linux-gnu libc6-dev-arm64-cross

      - name: Configure CMake (x86 Compile Database)
        run: mkdir build_x86 && cd build_x86 && cmake -DCMAKE_EXPORT_COMPILE_COMMANDS=ON ..

      - name: Configure CMake (ARM64 Compile Database)
        run: |
          mkdir build_arm && cd build_arm
          cmake -DCMAKE_SYSTEM_NAME=Linux \
                -DCMAKE_SYSTEM_PROCESSOR=aarch64 \
                -DCMAKE_C_COMPILER=aarch64-linux-gnu-gcc \
                -DCMAKE_EXPORT_COMPILE_COMMANDS=ON ..

      - name: Run Cppcheck (x86 Variants)
        run: |
          cppcheck --project=build_x86/compile_commands.json \
            --enable=all \
            --suppress=missingIncludeSystem --suppress=*:include/rapidhash.h \
            --check-level=exhaustive \
            --inline-suppr \
            --error-exitcode=1 \
            -j4

      - name: Run Cppcheck (ARM64 Variants)
        run: |
          cppcheck --project=build_arm/compile_commands.json \
            --enable=all \
            --suppress=missingIncludeSystem --suppress=*:include/rapidhash.h \
            --check-level=exhaustive \
            --inline-suppr \
            --error-exitcode=1 \
            -j4

  quality-checks:
    name: Code Quality - Advanced Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Install Analysis Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-tools valgrind cmake

      - name: Clang Static Analyzer (Scan-Build)
        run: |
          mkdir -p build_clang

          scan-build cmake -S . -B build_clang -DCMAKE_BUILD_TYPE=Debug
          scan-build --status-bugs cmake --build build_clang

      - name: Build for Valgrind (Debug)
        run: |
          cmake -S . -B build_valgrind -DCMAKE_BUILD_TYPE=Debug
          cmake --build build_valgrind

      - name: Valgrind Memory Check
        working-directory: build_valgrind
        run: |
          valgrind --leak-check=full \
                   --show-leak-kinds=all \
                   --track-origins=yes \
                   --error-exitcode=1 \
                   ./zxc_test

      - name: Unicode Linting
        shell: bash
        run: |
          echo "Scanning for non-ASCII characters in source files..."
          if grep -rP --include="*.c" --include="*.h" "[^\x00-\x7F]" .; then
            echo "::error::Non-ASCII characters found in source files."
            exit 1
          else
            echo "No non-ASCII characters found."
          fi